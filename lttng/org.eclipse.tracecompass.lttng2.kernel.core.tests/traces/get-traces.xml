<?xml version="1.0" encoding="UTF-8" ?>
<!--
   Copyright (C) 2015, Francis Giraldeau <francis.giraldeau@gmail.com>

   All rights reserved. This program and the accompanying materials
   are made available under the terms of the Eclipse Public License v1.0
   which accompanies this distribution, and is available at
   http://www.eclipse.org/legal/epl-v10.html
-->

<project name="Get traces" default="main">

	<!-- properties -->
	<property name="localhostTracesetDir" value="traceset/localhost/"/>
	<property name="archiveName" value="lttng-traceset-20150713"/>
	<!--
	   If the condition evaluates to false, the property is left undefined. The
	   target runs if the property is set, no matter its value. It means that
	   if the property is used as a target condition and has the value "false",
	   the target will run. This is totally silly, beware. In consequence, do
	   not add "else" element to condition.
	-->
	<target name="checkGitRepo">
		<condition property="needsCheckout">
			<and>
				<not>
					<available file="traceset/.git" type="dir" />
				</not>
			</and>
		</condition>
		<!-- Handy to understand what is going on -->
		<echo message="property needsCheckout=${needsCheckout}"/>
	</target>
	<target name="checkExtract">
		<condition property="needsExtract">
			<and>
				<available file="${localhostTracesetDir}/${archiveName}.tar.bz2" type="file" />
				<not>
					<available file="${localhostTracesetDir}/${archiveName}" type="dir" />
				</not>
			</and>
		</condition>
		<echo message="property needsExtract=${needsExtract}"/>
	</target>

	<target name="main" depends="extract"/>

	<target name="checkout" depends="checkGitRepo" if="needsCheckout">
		<exec executable = "git" failifexecutionfails="false" timeout="20000">
			<arg value = "clone"/>
			<arg value = "https://github.com/giraldeau/traceset.git"/>
		</exec>
	</target>

	<target name="pull" depends="checkout">
		<!-- Update the local 'master' branch -->
		<exec executable = "git" failifexecutionfails="false" dir="traceset" timeout="20000">
			<arg value = "checkout"/>
			<arg value = "master"/>
		</exec>
		<exec executable = "git" failifexecutionfails="false" dir="traceset" timeout="20000">
			<arg value = "pull"/>
		</exec>
	</target>

	<target name="extract" depends="pull,checkExtract" if="needsExtract">
		<bunzip2 src="${localhostTracesetDir}/${archiveName}.tar.bz2"/>
		<untar src="${localhostTracesetDir}/${archiveName}.tar" dest="${localhostTracesetDir}"/>
		<echo message="Traceset ${archiveName} extracted successfully"/>
	</target>
</project>
